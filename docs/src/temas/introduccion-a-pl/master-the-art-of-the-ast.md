---
---

# AST Transformations 

## Introduction

### Constant Folding

The following code uses estraverse to implement a simplified version of the AST tree transformation knwon as [Constant Folding](https://en.wikipedia.org/wiki/Constant_folding). **Constant folding** is the process of recognizing and evaluating constant expressions at compile time rather than computing them at runtime. 

```js
// See https://github.com/babel/minify/tree/master/packages/babel-plugin-minify-constant-folding
const fs = require("fs");
const deb = require("../src/deb.js");
const escodegen = require("escodegen");
const espree = require("espree");
const estraverse = require("estraverse");

const input = `
var f = 3+null;
var e = 4 | 3;
var d = 3+"c";
var b = 9 +1;
var a = 2+3*5+b;
`;

function replaceByLiteral(n) {
  n.type = "Literal";

  n.value = eval(`${n.left.raw} ${n.operator} ${n.right.raw}`);
  n.raw = String(n.value);

  delete n.left;
  delete n.right;
}

const t = espree.parse(input, { ecmaVersion: 6, loc: false });
estraverse.traverse(t, {
  leave: function (n, p) {
    if (
      n.type == "BinaryExpression" && 
        n.left.type == "Literal" && n.right.type == "Literal"
    ) { replaceByLiteral(n); }
  },
});
deb(t);
let c = escodegen.generate(t);
console.error(c);
```

Execution:

```js
➜  espree-logging-casiano-rodriguez-leon-alumno5 git:(train) ✗ node src/cf.js >salida.json                              
var f = 3;
var e = 7;
var d = '3c';
var b = 10;
var a = 17 + b;
```

* Vea los contenidos del árbol [salida.json](./cf-salida)

!!!include(temas/tree-transformations/master-the-ast-lectures.md)!!!

!!!include(temas/tree-transformations/codemod.md)!!!

!!!include(temas/tree-transformations/ast-types.md)!!!

!!!include(temas/tree-transformations/jscodeshift-recast.md)!!!

## References

### JSCodeshift

* <a href="https://github.com/facebook/jscodeshift" target="_blank">Codeshift at GitHub</a>
* [JSCodeshift API Doc](https://npmdoc.github.io/node-npmdoc-jscodeshift/build/apidoc.html)
* <a href="https://www.toptal.com/javascript/write-code-to-rewrite-your-code" target="_blank">Write Code to Rewrite Your Code: jscodeshift</a> Examples: removing console.log, replacing imported method calls, from positional parameters to parameter object
* <a href="https://glebbahmutov.com/blog/jscodeshift-example/" target="_blank">jscodeshift "hello world" example</a>
* <a href="https://github.com/cpojer/js-codemod/blob/master/transforms/no-vars.js" target="_blank">jscodeshift cpojer/js-codemod no-vars.js</a> Conservatively converts `var` to `const` or `let`. `jscodeshift -t js-codemod/transforms/no-vars.js <file>`



#### Rajasegar works

* [Migrating large codebase with Codemods](https://youtu.be/akKMopknEwc) YouTube video. Talk at JSFoo Pune 2020. On component architecture, performance, security for front-end, and emerging trends. Rajasegar Chandran.
  * [Slides](https://drive.google.com/file/d/1fHmdLBZktBE_yvhP4Oj75zoFOMYGuob5/view)
  * [Awesome codemods](https://github.com/rajasegar/awesome-codemods) at rajasegar/awesome-codemods

#### Riki Fridrich

* [Write a code that writes code](https://slideslive.com/38965948/write-a-code-that-writes-code?ref=account-13779-latest) talk by Riki Fridrich. Sep 22, 2021. WebExpo
* [fczbkk/talk-2021-09-22-webexpo-codemod](https://github.com/fczbkk/talk-2021-09-22-webexpo-codemod) GitHub Repo


### ast-types and recast 

* [recast](https://github.com/benjamn/recast)
* [ast-types examples in crguezl/hello-ast-types](https://github.com/crguezl/hello-ast-types)
* [api documentation for ast-types (v0.9.11)](https://npmdoc.github.io/node-npmdoc-ast-types/build/apidoc.html#apidoc.tableOfContents) (Don't trust it. Current version is 0.15) 

### Estraverse

* [Estraverse README.md](https://github.com/estools/estraverse/blob/master/README.md)
* Simple examples of AST traversal and transformation [crguezl/ast-traversal](https://github.com/crguezl/ast-traversal)

### Repositorios interesantes de cowchimp

* <a href="https://github.com/cowchimp/awesome-ast" target="_blank">A curated list of awesome AST resources</a>
* <a href="https://github.com/cowchimp/astscout" target="_blank">AST Scout is a tool for analyzing and visualizing the relationship between the public API of a Class\Module and its implementations details (e.g. private methods, dependencies used).</a>
* <a href="https://github.com/cowchimp/astexplorer" target="_blank">A web tool to explore the ASTs generated by various parsers. https://astexplorer.net/</a> The repo

### AST: Awesome Super Tool - JS Roundabout - April 2019

This is a talk similar to Yonatan Mevorach by Leonardo Crespo given in 2019:

* [AST: Awesome Super Tool - JS Roundabout - April 2019](https://youtu.be/N5v8Ul6ph90) by Leonardo Crespo
